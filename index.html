<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo 1 - Evaluaci√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: #764ba2;
            text-align: center;
            margin-bottom: 30px;
            font-size: 20px;
            font-weight: normal;
        }

        .qr-section {
            text-align: center;
            margin: 30px 0;
        }

        #qrcode {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .question-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .question-text {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .option {
            display: block;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option input[type="radio"] {
            margin-right: 10px;
        }

        .signature-section {
            margin: 30px 0;
        }

        #signatureCanvas {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
            background: white;
        }

        .signature-buttons {
            text-align: center;
            margin-top: 15px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }

        button:hover {
            background: #5568d3;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        .hidden {
            display: none;
        }

        .result-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

        .score {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .result-message {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 22px;
            }

            h2 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla 1: QR y Bienvenida -->
        <div id="welcomeScreen">
            <h1>M√≥dulo 1</h1>
            <h2>Cotizaci√≥n, Consentimiento de Bur√≥ y Precalificaci√≥n</h2>
            
            <div class="instructions">
                <p><strong>üìã Instrucciones:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>La prueba consta de 10 preguntas aleatorias</li>
                    <li>Cada pregunta vale 10 puntos</li>
                    <li>Debes completar todos los campos y firmar</li>
                    <li>Al finalizar recibir√°s tu calificaci√≥n y un PDF</li>
                </ul>
            </div>

            <div class="qr-section">
                <p style="margin-bottom: 15px; color: #666;">Escanea el c√≥digo QR para acceder desde tu m√≥vil</p>
                <div id="qrcode"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="startExam()">Iniciar Evaluaci√≥n</button>
            </div>
        </div>

        <!-- Pantalla 2: Datos del Usuario -->
        <div id="userDataScreen" class="hidden">
            <h1>Datos del Evaluado</h1>
            <h2>Por favor ingresa tu informaci√≥n</h2>

            <div class="form-group">
                <label for="userName">Nombre Completo *</label>
                <input type="text" id="userName" placeholder="Ingresa tu nombre completo" required>
            </div>

            <div class="form-group">
                <label for="userDPI">DPI *</label>
                <input type="text" id="userDPI" placeholder="Ingresa tu n√∫mero de DPI" required>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="validateUserData()">Continuar</button>
            </div>
        </div>

        <!-- Pantalla 3: Examen -->
        <div id="examScreen" class="hidden">
            <h1>Evaluaci√≥n - M√≥dulo 1</h1>
            
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>

            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Pregunta <span id="currentQuestion">0</span> de 10
            </p>

            <div id="questionsContainer"></div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="submitAnswers()">Finalizar Evaluaci√≥n</button>
            </div>
        </div>

        <!-- Pantalla 4: Firma -->
        <div id="signatureScreen" class="hidden">
            <h1>Firma Digital</h1>
            <h2>Por favor firma en el recuadro para validar tu evaluaci√≥n</h2>

            <div class="signature-section">
                <canvas id="signatureCanvas" width="600" height="200"></canvas>
                <div class="signature-buttons">
                    <button class="secondary" onclick="clearSignature()">Limpiar Firma</button>
                    <button onclick="submitSignature()">Confirmar y Calificar</button>
                </div>
            </div>
        </div>

        <!-- Pantalla 5: Resultados -->
        <div id="resultScreen" class="hidden">
            <h1>Resultados de la Evaluaci√≥n</h1>
            
            <div class="result-section">
                <p class="result-message">Tu puntuaci√≥n es:</p>
                <div class="score" id="finalScore">0</div>
                <p id="resultMessage" style="font-size: 20px; margin-bottom: 20px;"></p>
                
                <div style="margin-top: 30px;">
                    <p><strong>Nombre:</strong> <span id="resultName"></span></p>
                    <p><strong>DPI:</strong> <span id="resultDPI"></span></p>
                    <p><strong>Fecha:</strong> <span id="resultDate"></span></p>
                    <p><strong>Respuestas Correctas:</strong> <span id="correctAnswers"></span>/10</p>
                </div>

                <button onclick="downloadPDF()" style="margin-top: 30px;">üìÑ Descargar Certificado PDF</button>
                <button class="secondary" onclick="location.reload()" style="margin-top: 10px;">üîÑ Nueva Evaluaci√≥n</button>
            </div>
        </div>
    </div>

    <script>
        // Base de datos de preguntas
        const allQuestions = [
            {q: "¬øQu√© es una cotizaci√≥n?", options: ["a) Una factura de compra obligatoria", "b) Un documento que detalla el precio y condiciones de un producto o servicio", "c) Un contrato vinculante entre cliente y empresa", "d) Un registro contable de ventas realizadas"], answer: "b"},
            {q: "¬øUna cotizaci√≥n genera registro contable por s√≠ sola?", options: ["a) S√≠, siempre", "b) Solo si supera cierto monto", "c) No, es un documento informativo", "d) Solo cuando el cliente la acepta verbalmente"], answer: "c"},
            {q: "¬øCu√°l es el segundo paso para ingresar una cotizaci√≥n en el sistema eLO?", options: ["a) Ingresar los datos del cliente", "b) Clic en el bot√≥n 'Cotizaciones'", "c) Clic en el bot√≥n 'Guardar'", "d) Clic en el bot√≥n 'Agregar Nuevo'"], answer: "d"},
            {q: "¬øPara qu√© sirve el plazo de validez en una cotizaci√≥n?", options: ["a) Para garantizar el precio indefinidamente", "b) Para establecer el tiempo de entrega del producto", "c) Despu√©s de este plazo el precio podr√≠a cambiar por factores como inflaci√≥n o tipo de cambio", "d) Para cumplir con regulaciones fiscales"], answer: "c"},
            {q: "¬øQu√© ocurre cuando una cotizaci√≥n es aceptada formalmente por el cliente?", options: ["a) Se elimina del sistema autom√°ticamente", "b) Se convierte en la base de un contrato", "c) Se env√≠a directamente a contabilidad", "d) Pierde su validez inmediatamente"], answer: "b"},
            {q: "¬øCon qu√© otro nombre se le conoce com√∫nmente a una cotizaci√≥n?", options: ["a) Factura comercial", "b) Orden de compra", "c) Presupuesto o presupuesto comercial", "d) Nota de cr√©dito"], answer: "c"},
            {q: "¬øEn qu√© formato se descarga la cotizaci√≥n al dar clic en 'Imprimir'?", options: ["a) Word (.docx)", "b) Excel (.xlsx)", "c) PDF", "d) Imagen (.jpg)"], answer: "c"},
            {q: "¬øCu√°ntos pasos hay para ingresar una cotizaci√≥n al sistema eLO?", options: ["a) 3 pasos", "b) 5 pasos", "c) 7 pasos", "d) 10 pasos"], answer: "b"},
            {q: "¬øCu√°l NO es una mejora futura planeada para el m√≥dulo de cotizaciones?", options: ["a) Implementaci√≥n de t√©rminos y condiciones", "b) Cotizaci√≥n autom√°tica en todos los plazos", "c) Conexi√≥n con redes sociales", "d) Todas las anteriores son mejoras planeadas"], answer: "c"},
            {q: "¬øQu√© informaci√≥n incluye el PDF de la cotizaci√≥n impresa?", options: ["a) Solo el precio del producto", "b) √önicamente los datos del cliente", "c) Datos del cliente, producto cotizado e informaci√≥n de contacto del vendedor", "d) Solo la cuota mensual"], answer: "c"},
            {q: "¬øQu√© es un consentimiento de verificaci√≥n de bur√≥?", options: ["a) Un documento que garantiza la aprobaci√≥n del cr√©dito", "b) Una autorizaci√≥n para consultar el historial crediticio", "c) Un contrato de pr√©stamo", "d) Una solicitud de cr√©dito formal"], answer: "b"},
            {q: "¬øEl consentimiento de bur√≥ es obligatorio u opcional?", options: ["a) Obligatorio por ley", "b) Voluntario", "c) Obligatorio solo para montos altos", "d) Opcional solo en casos especiales"], answer: "b"},
            {q: "¬øQu√© aplicaci√≥n se utiliza para enviar el link de autorizaci√≥n al cliente?", options: ["a) Email", "b) SMS", "c) WhatsApp", "d) Telegram"], answer: "c"},
            {q: "¬øCu√°l es el estado inicial de una autorizaci√≥n despu√©s de enviar el link?", options: ["a) Aprobado", "b) En proceso", "c) Pendiente", "d) Firmado"], answer: "c"},
            {q: "¬øQu√© debe ingresar el cliente primero al abrir el link recibido?", options: ["a) Su correo electr√≥nico", "b) Su contrase√±a", "c) Su n√∫mero de identificaci√≥n", "d) Su firma digital"], answer: "c"},
            {q: "¬øSe puede revocar un consentimiento de bur√≥?", options: ["a) No, nunca", "b) S√≠, en muchos casos escribiendo a la empresa", "c) Solo despu√©s de 5 a√±os", "d) √önicamente con orden judicial"], answer: "b"},
            {q: "¬øCu√°ntos pasos debe seguir el cliente para firmar el consentimiento?", options: ["a) 3 pasos", "b) 4 pasos", "c) 6 pasos", "d) 8 pasos"], answer: "c"},
            {q: "¬øA qu√© estado cambia el consentimiento despu√©s de que el cliente lo firma?", options: ["a) Aprobado", "b) Completado", "c) Firmado", "d) Validado"], answer: "c"},
            {q: "¬øQu√© bot√≥n se habilita una vez que el consentimiento est√° firmado?", options: ["a) Aprobar", "b) Precalificar", "c) Finalizar", "d) Imprimir"], answer: "b"},
            {q: "¬øCu√°l NO es un prop√≥sito del consentimiento de bur√≥?", options: ["a) Evaluar el historial crediticio", "b) Agilizar solicitudes", "c) Garantizar la aprobaci√≥n del cr√©dito", "d) Construir una base de datos"], answer: "c"},
            {q: "¬øQu√© es una precalificaci√≥n?", options: ["a) Una aprobaci√≥n final de cr√©dito", "b) Una evaluaci√≥n preliminar e informal de capacidad financiera", "c) Un contrato de pr√©stamo", "d) Una verificaci√≥n de empleo"], answer: "b"},
            {q: "¬øLa precalificaci√≥n afecta el puntaje crediticio?", options: ["a) S√≠, siempre lo reduce", "b) Solo si es rechazada", "c) Generalmente no lo afecta", "d) Lo aumenta autom√°ticamente"], answer: "c"},
            {q: "¬øDesde qu√© pantalla se accede al bot√≥n 'Precalificar'?", options: ["a) Desde la pantalla de Cotizaciones", "b) Desde la pantalla de Autorizaci√≥n Bur√≥", "c) Desde el men√∫ principal", "d) Desde la pantalla de clientes"], answer: "b"},
            {q: "¬øQu√© documento se debe subir durante el proceso de precalificaci√≥n?", options: ["a) Recibo de agua", "b) Imagen del documento de identificaci√≥n", "c) Constancia de trabajo", "d) T√≠tulo de propiedad"], answer: "b"},
            {q: "¬øCu√°l es el primer tipo de validaci√≥n en la l√≥gica de precalificaci√≥n?", options: ["a) Score de bur√≥", "b) Nivel de endeudamiento", "c) Validaci√≥n K.O.", "d) Listas negras"], answer: "c"},
            {q: "¬øCu√°ntas listas negras se validan en el proceso?", options: ["a) 1 lista", "b) 2 listas", "c) 3 listas", "d) 4 listas (3 listas negras espec√≠ficas + red de personas)"], answer: "d"},
            {q: "¬øQu√© significa K.O. en el contexto de validaci√≥n?", options: ["a) Knockout - criterios de eliminaci√≥n autom√°tica", "b) Keep On - continuar proceso", "c) Key Operation - operaci√≥n clave", "d) Knowledge Output - salida de conocimiento"], answer: "a"},
            {q: "¬øCu√°l NO es un criterio de validaci√≥n K.O.?", options: ["a) Edad", "b) Nacionalidad", "c) Nivel educativo", "d) Estado civil"], answer: "c"},
            {q: "¬øCu√°ntas mejoras futuras est√°n planeadas para precalificaci√≥n?", options: ["a) 1 mejora", "b) 2 mejoras", "c) 3 mejoras", "d) 5 mejoras"], answer: "c"},
            {q: "¬øQu√© se debe revisar al finalizar una precalificaci√≥n?", options: ["a) Solo el monto aprobado", "b) Tabla de cuotas m√°ximas, montos m√°ximos y el Resumen (Aplica/No Aplica)", "c) √önicamente el score crediticio", "d) Solo la fecha de vencimiento"], answer: "b"}
        ];

        // Variables globales
        let selectedQuestions = [];
        let userAnswers = [];
        let userData = {};
        let signatureData = null;
        let canvas, ctx;
        let isDrawing = false;

        // Generar QR Code al cargar la p√°gina
        window.onload = function() {
            const currentURL = window.location.href;
            new QRCode(document.getElementById("qrcode"), {
                text: currentURL,
                width: 200,
                height: 200,
                colorDark: "#667eea",
                colorLight: "#ffffff",
            });
        };

        // Funci√≥n para iniciar el examen
        function startExam() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('userDataScreen').classList.remove('hidden');
        }

        // Validar datos del usuario
        function validateUserData() {
            const name = document.getElementById('userName').value.trim();
            const dpi = document.getElementById('userDPI').value.trim();

            if (name === '' || dpi === '') {
                alert('Por favor completa todos los campos');
                return;
            }

            userData = {
                name: name,
                dpi: dpi,
                date: new Date().toLocaleString('es-GT')
            };

            // Guardar en localStorage
            localStorage.setItem('examUserData', JSON.stringify(userData));

            // Generar preguntas aleatorias
            generateRandomQuestions();

            // Mostrar pantalla de examen
            document.getElementById('userDataScreen').classList.add('hidden');
            document.getElementById('examScreen').classList.remove('hidden');
        }

        // Generar 10 preguntas aleatorias
        function generateRandomQuestions() {
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            selectedQuestions = shuffled.slice(0, 10);
            
            // Guardar en localStorage
            localStorage.setItem('examQuestions', JSON.stringify(selectedQuestions));

            renderQuestions();
        }

        // Renderizar preguntas
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            selectedQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.innerHTML = `
                    <div class="question-text">${index + 1}. ${question.q}</div>
                    ${question.options.map((option, optIndex) => `
                        <label class="option">
                            <input type="radio" name="question${index}" value="${String.fromCharCode(97 + optIndex)}" onchange="updateProgress()">
                            ${option}
                        </label>
                    `).join('')}
                `;
                container.appendChild(questionCard);
            });
        }

        // Actualizar progreso
        function updateProgress() {
            let answered = 0;
            for (let i = 0; i < 10; i++) {
                const selected = document.querySelector(`input[name="question${i}"]:checked`);
                if (selected) answered++;
            }

            const progress = (answered / 10) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = answered;
        }

        // Enviar respuestas
        function submitAnswers() {
            userAnswers = [];
            let allAnswered = true;

            for (let i = 0; i < 10; i++) {
                const selected = document.querySelector(`input[name="question${i}"]:checked`);
                if (!selected) {
                    allAnswered = false;
                    break;
                }
                userAnswers.push(selected.value);
            }

            if (!allAnswered) {
                alert('Por favor responde todas las preguntas antes de continuar');
                return;
            }

            // Guardar respuestas
            localStorage.setItem('examAnswers', JSON.stringify(userAnswers));

            // Mostrar pantalla de firma
            document.getElementById('examScreen').classList.add('hidden');
            document.getElementById('signatureScreen').classList.remove('hidden');

            // Inicializar canvas de firma
            initSignatureCanvas();
        }

        // Inicializar canvas de firma
        function initSignatureCanvas() {
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');

            // Ajustar para pantallas m√≥viles
            if (window.innerWidth < 600) {
                canvas.width = window.innerWidth - 80;
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events para m√≥viles
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function submitSignature() {
            // Verificar que hay firma
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let hasSignature = false;

            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 0) {
                    hasSignature = true;
                    break;
                }
            }

            if (!hasSignature) {
                alert('Por favor firma antes de continuar');
                return;
            }

            signatureData = canvas.toDataURL();
            localStorage.setItem('examSignature', signatureData);

            // Calcular resultados
            calculateResults();
        }

        // Calcular resultados
        function calculateResults() {
            let correct = 0;
            
            for (let i = 0; i < 10; i++) {
                if (userAnswers[i] === selectedQuestions[i].answer) {
                    correct++;
                }
            }

            const score = correct * 10;
            
            // Guardar resultados
            const results = {
                score: score,
                correct: correct,
                total: 10,
                date: userData.date
            };
            localStorage.setItem('examResults', JSON.stringify(results));

            // Mostrar resultados
            showResults(score, correct);
        }

        // Mostrar resultados
        function showResults(score, correct) {
            document.getElementById('signatureScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');

            document.getElementById('finalScore').textContent = score + ' pts';
            document.getElementById('resultName').textContent = userData.name;
            document.getElementById('resultDPI').textContent = userData.dpi;
            document.getElementById('resultDate').textContent = userData.date;
            document.getElementById('correctAnswers').textContent = correct;

            let message = '';
            if (score >= 90) {
                message = 'üéâ ¬°Excelente! Dominas el tema';
            } else if (score >= 70) {
                message = 'üëç ¬°Muy bien! Buen conocimiento del tema';
            } else if (score >= 60) {
                message = '‚úÖ Aprobado. Contin√∫a estudiando';
            } else {
                message = 'üìö Necesitas repasar el material';
            }

            document.getElementById('resultMessage').textContent = message;
        }

        // Descargar PDF
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Recuperar datos del localStorage
            const userData = JSON.parse(localStorage.getItem('examUserData'));
            const results = JSON.parse(localStorage.getItem('examResults'));
            const signature = localStorage.getItem('examSignature');
            const questions = JSON.parse(localStorage.getItem('examQuestions'));
            const answers = JSON.parse(localStorage.getItem('examAnswers'));

            let yPosition = 20;

            // ============ P√ÅGINA 1: ENCABEZADO Y RESUMEN ============
            
            // Encabezado
            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text('CERTIFICADO DE EVALUACI√ìN', 105, 18, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text('M√≥dulo 1: Cotizaci√≥n, Consentimiento de Bur√≥ y Precalificaci√≥n', 105, 28, { align: 'center' });
            
            doc.setFontSize(11);
            doc.text('Departamento de Cr√©ditos Avanta', 105, 37, { align: 'center' });

            yPosition = 55;

            // Informaci√≥n del evaluado
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Datos del Evaluado:', 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Nombre: ${userData.name}`, 20, yPosition);
            yPosition += 6;
            doc.text(`DPI: ${userData.dpi}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Fecha: ${userData.date}`, 20, yPosition);
            yPosition += 12;

            // Resultados resumidos
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Resumen de Resultados:', 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de Preguntas: ${results.total}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Respuestas Correctas: ${results.correct}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Respuestas Incorrectas: ${results.total - results.correct}`, 20, yPosition);
            yPosition += 12;

            // Puntuaci√≥n destacada
            doc.setFillColor(248, 249, 250);
            doc.rect(15, yPosition - 5, 180, 25, 'F');
            
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(102, 126, 234);
            doc.text(`PUNTUACI√ìN FINAL: ${results.score} / 100 pts`, 105, yPosition + 8, { align: 'center' });

            // Estado
            doc.setFontSize(16);
            if (results.score >= 60) {
                doc.setTextColor(46, 204, 113);
                doc.text('‚úì APROBADO', 105, yPosition + 18, { align: 'center' });
            } else {
                doc.setTextColor(231, 76, 60);
                doc.text('‚úó NO APROBADO', 105, yPosition + 18, { align: 'center' });
            }

            yPosition += 30;

            // Firma del evaluado
            if (signature) {
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Firma Digital del Evaluado:', 20, yPosition);
                yPosition += 2;
                doc.addImage(signature, 'PNG', 20, yPosition, 70, 23);
                yPosition += 25;
            }

            // ============ P√ÅGINA 2+: DETALLE DE PREGUNTAS Y RESPUESTAS ============
            
            doc.addPage();
            yPosition = 20;

            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text('DETALLE DE PREGUNTAS Y RESPUESTAS', 105, 10, { align: 'center' });

            yPosition = 25;

            // Iterar sobre todas las preguntas
            for (let i = 0; i < questions.length; i++) {
                const question = questions[i];
                const userAnswer = answers[i];
                const isCorrect = userAnswer === question.answer;

                // Verificar si necesitamos una nueva p√°gina
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }

                // N√∫mero de pregunta y estado
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                
                if (isCorrect) {
                    doc.setTextColor(46, 204, 113);
                    doc.text(`‚úì`, 15, yPosition);
                } else {
                    doc.setTextColor(231, 76, 60);
                    doc.text(`‚úó`, 15, yPosition);
                }
                
                doc.setTextColor(0, 0, 0);
                doc.text(`Pregunta ${i + 1}:`, 22, yPosition);
                yPosition += 6;

                // Texto de la pregunta (con wrapping)
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                const questionLines = doc.splitTextToSize(question.q, 170);
                doc.text(questionLines, 20, yPosition);
                yPosition += (questionLines.length * 5);

                // Opciones
                yPosition += 3;
                for (let j = 0; j < question.options.length; j++) {
                    const optionLetter = String.fromCharCode(97 + j); // a, b, c, d
                    const isUserAnswer = userAnswer === optionLetter;
                    const isCorrectAnswer = question.answer === optionLetter;

                    // Verificar espacio
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.setFontSize(8);
                    
                    // Marcar la respuesta del usuario y la correcta
                    if (isUserAnswer && isCorrectAnswer) {
                        // Respuesta correcta del usuario
                        doc.setTextColor(46, 204, 113);
                        doc.setFont(undefined, 'bold');
                        doc.text('‚û§', 23, yPosition);
                    } else if (isUserAnswer && !isCorrectAnswer) {
                        // Respuesta incorrecta del usuario
                        doc.setTextColor(231, 76, 60);
                        doc.setFont(undefined, 'bold');
                        doc.text('‚û§', 23, yPosition);
                    } else if (!isUserAnswer && isCorrectAnswer) {
                        // La respuesta correcta (no seleccionada)
                        doc.setTextColor(46, 204, 113);
                        doc.setFont(undefined, 'italic');
                        doc.text('‚úì', 23, yPosition);
                    }

                    // Texto de la opci√≥n
                    if (isUserAnswer) {
                        doc.setFont(undefined, 'bold');
                    } else {
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(0, 0, 0);
                    }

                    const optionLines = doc.splitTextToSize(question.options[j], 160);
                    doc.text(optionLines, 30, yPosition);
                    yPosition += (optionLines.length * 4) + 1;
                }

                // Explicaci√≥n de la respuesta
                yPosition += 2;
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                if (isCorrect) {
                    doc.setTextColor(46, 204, 113);
                    doc.text(`Respuesta correcta: ${question.answer.toUpperCase()}`, 30, yPosition);
                } else {
                    doc.setTextColor(231, 76, 60);
                    doc.text(`Tu respuesta: ${userAnswer.toUpperCase()} | Correcta: ${question.answer.toUpperCase()}`, 30, yPosition);
                }

                yPosition += 8;

                // L√≠nea separadora
                doc.setDrawColor(200, 200, 200);
                doc.line(20, yPosition, 190, yPosition);
                yPosition += 8;
            }

            // ============ P√ÅGINA FINAL: FIRMAS DE APROBACI√ìN ============
            
            doc.addPage();
            yPosition = 20;

            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text('APROBACI√ìN Y VALIDACI√ìN', 105, 10, { align: 'center' });

            yPosition = 35;

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text('Este documento certifica que el evaluado ha completado satisfactoriamente la evaluaci√≥n', 105, yPosition, { align: 'center' });
            yPosition += 5;
            doc.text('del M√≥dulo 1 y requiere la aprobaci√≥n de las siguientes autoridades:', 105, yPosition, { align: 'center' });
            yPosition += 20;

            // Firma del Coordinador
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('COORDINADOR DE CR√âDITOS', 20, yPosition);
            yPosition += 15;
            
            doc.setLineWidth(0.5);
            doc.setDrawColor(0, 0, 0);
            doc.line(20, yPosition, 90, yPosition);
            yPosition += 5;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('Firma y Sello', 20, yPosition);
            yPosition += 3;
            doc.text(`Fecha: _____/_____/_____`, 20, yPosition);
            yPosition += 25;

            // Firma del Jefe de Cr√©ditos
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('JEFE DE CR√âDITOS', 20, yPosition);
            yPosition += 15;
            
            doc.line(20, yPosition, 90, yPosition);
            yPosition += 5;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('Firma y Sello', 20, yPosition);
            yPosition += 3;
            doc.text(`Fecha: _____/_____/_____`, 20, yPosition);
            yPosition += 25;

            // Firma del Gerente de Cr√©ditos
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('GERENTE DE CR√âDITOS', 20, yPosition);
            yPosition += 15;
            
            doc.line(20, yPosition, 90, yPosition);
            yPosition += 5;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('Firma y Sello', 20, yPosition);
            yPosition += 3;
            doc.text(`Fecha: _____/_____/_____`, 20, yPosition);

            // Nota al pie
            yPosition = 270;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.setFont(undefined, 'italic');
            doc.text('Este documento es v√°lido √∫nicamente con las tres firmas autorizadas y sus respectivos sellos.', 105, yPosition, { align: 'center' });
            yPosition += 4;
            doc.text('Departamento de Cr√©ditos Avanta - Sistema de Evaluaci√≥n y Capacitaci√≥n', 105, yPosition, { align: 'center' });

            // Pie de p√°gina en todas las p√°ginas
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`P√°gina ${i} de ${totalPages}`, 105, 290, { align: 'center' });
            }

            // Descargar
            doc.save(`Evaluacion_${userData.name.replace(/ /g, '_')}_${Date.now()}.pdf`);
        }
    </script>
</body>
</html>
