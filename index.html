<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo 1 - Evaluación</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: #764ba2;
            text-align: center;
            margin-bottom: 30px;
            font-size: 20px;
            font-weight: normal;
        }

        .qr-section {
            text-align: center;
            margin: 30px 0;
        }

        #qrcode {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .question-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .question-text {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .option {
            display: block;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option input[type="radio"] {
            margin-right: 10px;
        }

        .signature-section {
            margin: 30px 0;
        }

        #signatureCanvas {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
            background: white;
        }

        .signature-buttons {
            text-align: center;
            margin-top: 15px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }

        button:hover {
            background: #5568d3;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        .hidden {
            display: none;
        }

        .result-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

        .score {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .result-message {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 22px;
            }

            h2 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla 1: QR y Bienvenida -->
        <div id="welcomeScreen">
            <h1>Módulo 1</h1>
            <h2>Sistema eLO - Solicitud de Crédito y Asignación Automática</h2>
            
            <div class="instructions">
                <p><strong>📋 Instrucciones:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>La prueba consta de 10 preguntas aleatorias sobre el sistema eLO</li>
                    <li>Las preguntas abarcan temas como: proceso de solicitud, asignación automática, estados del ciclo, priorizaciones y más</li>
                    <li>Cada pregunta vale 10 puntos</li>
                    <li>Debes completar todos los campos y firmar</li>
                    <li>Al finalizar recibirás tu calificación y un PDF detallado</li>
                </ul>
            </div>

            <div class="qr-section">
                <p style="margin-bottom: 15px; color: #666;">Escanea el código QR para acceder desde tu móvil</p>
                <div id="qrcode"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="startExam()">Iniciar Evaluación</button>
            </div>
        </div>

        <!-- Pantalla 2: Datos del Usuario -->
        <div id="userDataScreen" class="hidden">
            <h1>Datos del Evaluado</h1>
            <h2>Por favor ingresa tu información</h2>

            <div class="form-group">
                <label for="userName">Nombre Completo *</label>
                <input type="text" id="userName" placeholder="Ingresa tu nombre completo" required>
            </div>

            <div class="form-group">
                <label for="userDPI">DPI *</label>
                <input type="text" id="userDPI" placeholder="Ingresa tu número de DPI" required>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="validateUserData()">Continuar</button>
            </div>
        </div>

        <!-- Pantalla 3: Examen -->
        <div id="examScreen" class="hidden">
            <h1>Evaluación - Módulo 1</h1>
            
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>

            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Pregunta <span id="currentQuestion">0</span> de 10
            </p>

            <div id="questionsContainer"></div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="submitAnswers()">Finalizar Evaluación</button>
            </div>
        </div>

        <!-- Pantalla 4: Firma -->
        <div id="signatureScreen" class="hidden">
            <h1>Firma Digital</h1>
            <h2>Por favor firma en el recuadro para validar tu evaluación</h2>

            <div class="signature-section">
                <canvas id="signatureCanvas" width="600" height="200"></canvas>
                <div class="signature-buttons">
                    <button class="secondary" onclick="clearSignature()">Limpiar Firma</button>
                    <button onclick="submitSignature()">Confirmar y Calificar</button>
                </div>
            </div>
        </div>

        <!-- Pantalla 5: Resultados -->
        <div id="resultScreen" class="hidden">
            <h1>Resultados de la Evaluación</h1>
            
            <div class="result-section">
                <p class="result-message">Tu puntuación es:</p>
                <div class="score" id="finalScore">0</div>
                <p id="resultMessage" style="font-size: 20px; margin-bottom: 20px;"></p>
                
                <div style="margin-top: 30px;">
                    <p><strong>Nombre:</strong> <span id="resultName"></span></p>
                    <p><strong>DPI:</strong> <span id="resultDPI"></span></p>
                    <p><strong>Fecha:</strong> <span id="resultDate"></span></p>
                    <p><strong>Respuestas Correctas:</strong> <span id="correctAnswers"></span>/10</p>
                </div>

                <button onclick="downloadPDF()" style="margin-top: 30px;">📄 Descargar Certificado PDF</button>
                <button class="secondary" onclick="location.reload()" style="margin-top: 10px;">🔄 Nueva Evaluación</button>
            </div>
        </div>
    </div>

    <script>
        // Base de datos de preguntas
        const allQuestions = [
            // Conceptos generales
            {category: "Conceptos Generales", q: "¿Qué es una solicitud de crédito?", options: ["a) Un documento informal para pedir dinero", "b) Un formulario para solicitar productos bancarios", "c) Un documento formal para pedir un préstamo", "d) Un registro de pagos mensuales"], answer: "c"},
            {category: "Conceptos Generales", q: "¿Qué información recopila una solicitud de crédito?", options: ["a) Solo datos personales", "b) Datos personales y financieros", "c) Solo ingresos", "d) Solo referencias"], answer: "b"},
            {category: "Conceptos Generales", q: "¿Quién evalúa la solicitud de crédito?", options: ["a) El cliente", "b) El gerente", "c) El prestamista", "d) El departamento de marketing"], answer: "c"},
            {category: "Conceptos Generales", q: "¿Qué busca determinar la evaluación del prestamista?", options: ["a) Nivel académico", "b) Riesgo crediticio", "c) Tiempo de residencia", "d) Capacidad legal"], answer: "b"},
            {category: "Conceptos Generales", q: "¿Cuál es el primer paso del proceso en eLO?", options: ["a) Datos laborales", "b) Información personal", "c) Dirección", "d) Carga de documentos"], answer: "b"},
            
            // Proceso en eLO
            {category: "Proceso en eLO", q: "¿Qué paso del proceso incluye el lugar de residencia?", options: ["a) Datos laborales", "b) Dirección", "c) Referencias", "d) Financiamiento"], answer: "b"},
            {category: "Proceso en eLO", q: "¿En qué paso se registran los ingresos del cliente?", options: ["a) Datos laborales", "b) Dirección", "c) Referencias", "d) Carga de documentos"], answer: "a"},
            {category: "Proceso en eLO", q: "¿En qué etapa se define el monto solicitado?", options: ["a) Financiamiento", "b) Referencias", "c) Información personal", "d) Reproceso"], answer: "a"},
            {category: "Proceso en eLO", q: "¿Cuál es el último paso del proceso de solicitud?", options: ["a) Referencias", "b) Financiamiento", "c) Carga de documentos", "d) Dirección"], answer: "c"},
            {category: "Proceso en eLO", q: "¿Qué beneficio principal ofrece la asignación automática?", options: ["a) Más control manual", "b) Reducción de eficiencia", "c) Distribución automática de tareas", "d) Menor cobertura"], answer: "c"},
            
            // Principios de la asignación automática
            {category: "Principios de la Asignación Automática", q: "¿Qué característica principal tiene la optimización?", options: ["a) Menos trabajo", "b) Equilibrio de carga entre analistas", "c) Reducción de personal", "d) Aumento de horas laborales"], answer: "b"},
            {category: "Principios de la Asignación Automática", q: "¿Qué busca la eficiencia?", options: ["a) Más papeleo", "b) Atención oportuna y consistente", "c) Menos seguimiento", "d) Más aprobaciones"], answer: "b"},
            {category: "Principios de la Asignación Automática", q: "¿Qué elimina la automatización?", options: ["a) Asignación manual lenta", "b) Reportes automáticos", "c) Control de tiempos", "d) Tareas digitales"], answer: "a"},
            {category: "Principios de la Asignación Automática", q: "¿Qué garantiza el sistema automatizado?", options: ["a) Asignación aleatoria", "b) Equidad en distribución", "c) Exclusión de analistas", "d) Procesos manuales"], answer: "b"},
            {category: "Principios de la Asignación Automática", q: "¿Qué tipo de mejoras se implementaron en eLO?", options: ["a) Mejores gráficos", "b) Cambios visuales", "c) Mejoras funcionales significativas", "d) Eliminación de módulos"], answer: "c"},
            
            // Cambios implementados
            {category: "Cambios Implementados", q: "¿Cuál de estos NO es un nuevo estado del sistema?", options: ["a) Reasignado", "b) Aprobado", "c) Verificaciones finalizadas", "d) Ingresado"], answer: "d"},
            {category: "Cambios Implementados", q: "¿Qué registra la grabación de tiempos?", options: ["a) Tiempos de conexión a internet", "b) Tiempos en cada acción", "c) Horas laborales totales", "d) Descansos"], answer: "b"},
            {category: "Cambios Implementados", q: "¿Para qué sirve el módulo de priorizaciones?", options: ["a) Para ordenar solicitudes según importancia", "b) Para eliminar solicitudes duplicadas", "c) Para generar reportes", "d) Para aprobar créditos"], answer: "a"},
            {category: "Cambios Implementados", q: "¿Qué mide la grabación de tiempos?", options: ["a) Productividad visual", "b) Eficiencia del proceso", "c) Nivel de riesgo", "d) Tiempo de descanso"], answer: "b"},
            {category: "Cambios Implementados", q: "¿Cuál NO es un estado de disponibilidad?", options: ["a) Almuerzo", "b) Disponible", "c) Pendiente de aprobación", "d) Capacitación"], answer: "c"},
            
            // Estados del ciclo
            {category: "Estados del Ciclo", q: "¿Qué significa el estado 'Ingresado'?", options: ["a) Solicitud aprobada", "b) Nueva solicitud en el sistema", "c) Solicitud eliminada", "d) Solicitud reprogramada"], answer: "b"},
            {category: "Estados del Ciclo", q: "¿Qué indica el estado 'Reproceso'?", options: ["a) Que ya fue aprobado", "b) Que requiere análisis adicional", "c) Que fue cancelado", "d) Que se duplicó"], answer: "b"},
            {category: "Estados del Ciclo", q: "¿Qué estado corresponde a una solicitud lista para evaluación?", options: ["a) Ingresado", "b) Reproceso", "c) Verificaciones finalizadas", "d) Devuelto"], answer: "c"},
            {category: "Estados del Ciclo", q: "¿Qué estado representa una solicitud que cumple hora de revisión?", options: ["a) Reprogramado", "b) Rechazado", "c) Devuelto", "d) Confirmado"], answer: "a"},
            {category: "Estados del Ciclo", q: "¿Cuál es un estado de finalización?", options: ["a) En revisión", "b) Rechazado", "c) Verificaciones finalizadas", "d) Reproceso"], answer: "b"},
            
            // Priorizaciones
            {category: "Priorizaciones", q: "¿Quién avala la configuración del módulo de priorizaciones?", options: ["a) Gerencia de Tecnología", "b) Gerencia Comercial y de Créditos", "c) Departamento de Ventas", "d) Mesa de Ayuda"], answer: "b"},
            {category: "Priorizaciones", q: "¿Qué representa el 'Nivel'?", options: ["a) Jerarquía de prioridad", "b) Tipo de cliente", "c) Orden cronológico", "d) Segmento de mercado"], answer: "a"},
            {category: "Priorizaciones", q: "¿Cuál tiene la máxima prioridad?", options: ["a) Nivel 3", "b) Nivel 2", "c) Nivel 1", "d) Nivel 0"], answer: "c"},
            {category: "Priorizaciones", q: "¿Qué es un Ítem dentro del módulo?", options: ["a) Variable usada dentro de un nivel", "b) Cliente registrado", "c) Analista disponible", "d) Tipo de crédito"], answer: "a"},
            {category: "Priorizaciones", q: "¿Qué determina el orden de asignación?", options: ["a) Orden aleatorio", "b) Configuración interna", "c) Fecha de ingreso", "d) Estado del cliente"], answer: "b"},
            
            // Ejemplo práctico
            {category: "Ejemplo Práctico", q: "¿Qué tipo de cliente tiene nivel 1?", options: ["a) Estándar", "b) Nuevo", "c) Premium", "d) Rechazado"], answer: "c"},
            {category: "Ejemplo Práctico", q: "En el nivel 2, ¿qué tipo de montos se priorizan primero?", options: ["a) Menores a $50,000", "b) Superiores a $50,000", "c) Exactos a $50,000", "d) Iguales para todos"], answer: "b"},
            {category: "Ejemplo Práctico", q: "En el nivel 3, ¿qué ítem tiene menor prioridad?", options: ["a) Con referencias bancarias", "b) Sin historial crediticio", "c) Con historial", "d) Antiguos clientes"], answer: "b"},
            {category: "Ejemplo Práctico", q: "¿Qué orden se asigna a las renovaciones de clientes premium?", options: ["a) 1", "b) 2", "c) 3", "d) Ninguno"], answer: "a"},
            {category: "Ejemplo Práctico", q: "¿Qué representa el orden 2 en el nivel 1?", options: ["a) Nuevas solicitudes", "b) Rechazadas", "c) Reprocesos", "d) Aprobadas"], answer: "a"},
            
            // Lógica de asignación
            {category: "Lógica de Asignación", q: "¿Qué principio garantiza que el proceso no quede incompleto?", options: ["a) Priorización", "b) Inicio y fin definidos", "c) Disponibilidad", "d) Grabación de tiempos"], answer: "b"},
            {category: "Lógica de Asignación", q: "¿Qué se garantiza con la priorización estratégica?", options: ["a) Aleatoriedad", "b) Que las críticas se atiendan primero", "c) Que todas se atiendan igual", "d) Que no haya prioridades"], answer: "b"},
            {category: "Lógica de Asignación", q: "¿Qué factor evita cuellos de botella?", options: ["a) Asignación aleatoria", "b) Asignación a analistas disponibles", "c) Eliminar analistas", "d) Reproceso continuo"], answer: "b"},
            {category: "Lógica de Asignación", q: "¿Qué se asegura con la disponibilidad del analista?", options: ["a) Que el cliente espere más", "b) Que la carga se distribuya equitativamente", "c) Que haya reprocesos", "d) Que se dupliquen solicitudes"], answer: "b"},
            {category: "Lógica de Asignación", q: "¿Qué pilar garantiza seguimiento integral?", options: ["a) Inicio y fin definidos", "b) Priorización", "c) Disponibilidad", "d) Grabación"], answer: "a"},
            
            // Beneficios del sistema
            {category: "Beneficios del Sistema", q: "¿Qué significa cobertura total?", options: ["a) Solo algunas solicitudes se procesan", "b) Todas las solicitudes son procesadas", "c) Solo las urgentes", "d) Solo las digitales"], answer: "b"},
            {category: "Beneficios del Sistema", q: "¿Qué efecto tiene sobre los tiempos de análisis?", options: ["a) Aumentan", "b) Disminuyen", "c) Se duplican", "d) No cambian"], answer: "b"},
            {category: "Beneficios del Sistema", q: "¿Qué cantidad de errores manuales busca el sistema?", options: ["a) 5%", "b) 1%", "c) 0%", "d) 10%"], answer: "c"},
            {category: "Beneficios del Sistema", q: "¿Qué se elimina con la automatización?", options: ["a) Asignaciones duplicadas", "b) Prioridades", "c) Estados finales", "d) Reportes"], answer: "a"},
            {category: "Beneficios del Sistema", q: "¿Qué garantiza el sistema eLO?", options: ["a) Eficiencia y transparencia", "b) Mayor carga manual", "c) Pérdida de seguimiento", "d) Asignación lenta"], answer: "a"},
            
            // Conclusiones
            {category: "Conclusiones", q: "¿Qué tipo de trabajo se distribuye equitativamente?", options: ["a) Comercial", "b) Análisis de solicitudes", "c) Logístico", "d) Publicitario"], answer: "b"},
            {category: "Conclusiones", q: "¿Qué aspecto NO es un beneficio directo del sistema?", options: ["a) Equidad", "b) Transparencia", "c) Reducción de tiempos", "d) Pérdida de trazabilidad"], answer: "d"},
            {category: "Conclusiones", q: "¿Qué mejora principal aporta la automatización al equipo?", options: ["a) Control manual", "b) Optimización del tiempo", "c) Aumento de errores", "d) Reprocesos innecesarios"], answer: "b"},
            {category: "Conclusiones", q: "¿Cómo afecta el sistema al cliente final?", options: ["a) Más demoras", "b) Atención más oportuna", "c) Menos transparencia", "d) Menor cobertura"], answer: "b"},
            {category: "Conclusiones", q: "¿Qué representa globalmente el sistema eLO?", options: ["a) Un sistema manual", "b) Un proceso ineficiente", "c) Una transformación digital hacia eficiencia y equidad", "d) Un método temporal"], answer: "c"}
        ];

        // Variables globales
        let selectedQuestions = [];
        let userAnswers = [];
        let userData = {};
        let signatureData = null;
        let canvas, ctx;
        let isDrawing = false;

        // Generar QR Code al cargar la página
        window.onload = function() {
            const currentURL = window.location.href;
            new QRCode(document.getElementById("qrcode"), {
                text: currentURL,
                width: 200,
                height: 200,
                colorDark: "#667eea",
                colorLight: "#ffffff",
            });
        };

        // Función para iniciar el examen
        function startExam() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('userDataScreen').classList.remove('hidden');
        }

        // Validar datos del usuario
        function validateUserData() {
            const name = document.getElementById('userName').value.trim();
            const dpi = document.getElementById('userDPI').value.trim();

            if (name === '' || dpi === '') {
                alert('Por favor completa todos los campos');
                return;
            }

            userData = {
                name: name,
                dpi: dpi,
                date: new Date().toLocaleString('es-GT')
            };

            // Guardar en localStorage
            localStorage.setItem('examUserData', JSON.stringify(userData));

            // Generar preguntas aleatorias
            generateRandomQuestions();

            // Mostrar pantalla de examen
            document.getElementById('userDataScreen').classList.add('hidden');
            document.getElementById('examScreen').classList.remove('hidden');
        }

        // Generar 10 preguntas aleatorias
        function generateRandomQuestions() {
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            selectedQuestions = shuffled.slice(0, 10);
            
            // Guardar en localStorage
            localStorage.setItem('examQuestions', JSON.stringify(selectedQuestions));

            renderQuestions();
        }

        // Renderizar preguntas
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            selectedQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.innerHTML = `
                    <div style="font-size: 11px; color: #667eea; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">
                        ${question.category}
                    </div>
                    <div class="question-text">${index + 1}. ${question.q}</div>
                    ${question.options.map((option, optIndex) => `
                        <label class="option">
                            <input type="radio" name="question${index}" value="${String.fromCharCode(97 + optIndex)}" onchange="updateProgress()">
                            ${option}
                        </label>
                    `).join('')}
                `;
                container.appendChild(questionCard);
            });
        }

        // Actualizar progreso
        function updateProgress() {
            let answered = 0;
            for (let i = 0; i < 10; i++) {
                const selected = document.querySelector(`input[name="question${i}"]:checked`);
                if (selected) answered++;
            }

            const progress = (answered / 10) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = answered;
        }

        // Enviar respuestas
        function submitAnswers() {
            userAnswers = [];
            let allAnswered = true;

            for (let i = 0; i < 10; i++) {
                const selected = document.querySelector(`input[name="question${i}"]:checked`);
                if (!selected) {
                    allAnswered = false;
                    break;
                }
                userAnswers.push(selected.value);
            }

            if (!allAnswered) {
                alert('Por favor responde todas las preguntas antes de continuar');
                return;
            }

            // Guardar respuestas
            localStorage.setItem('examAnswers', JSON.stringify(userAnswers));

            // Mostrar pantalla de firma
            document.getElementById('examScreen').classList.add('hidden');
            document.getElementById('signatureScreen').classList.remove('hidden');

            // Inicializar canvas de firma
            initSignatureCanvas();
        }

        // Inicializar canvas de firma
        function initSignatureCanvas() {
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');

            // Ajustar para pantallas móviles
            if (window.innerWidth < 600) {
                canvas.width = window.innerWidth - 80;
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events para móviles
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function submitSignature() {
            // Verificar que hay firma
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let hasSignature = false;

            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 0) {
                    hasSignature = true;
                    break;
                }
            }

            if (!hasSignature) {
                alert('Por favor firma antes de continuar');
                return;
            }

            signatureData = canvas.toDataURL();
            localStorage.setItem('examSignature', signatureData);

            // Calcular resultados
            calculateResults();
        }

        // Calcular resultados
        function calculateResults() {
            let correct = 0;
            
            for (let i = 0; i < 10; i++) {
                if (userAnswers[i] === selectedQuestions[i].answer) {
                    correct++;
                }
            }

            const score = correct * 10;
            
            // Guardar resultados
            const results = {
                score: score,
                correct: correct,
                total: 10,
                date: userData.date
            };
            localStorage.setItem('examResults', JSON.stringify(results));

            // Mostrar resultados
            showResults(score, correct);
        }

        // Mostrar resultados
        function showResults(score, correct) {
            document.getElementById('signatureScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');

            document.getElementById('finalScore').textContent = score + ' pts';
            document.getElementById('resultName').textContent = userData.name;
            document.getElementById('resultDPI').textContent = userData.dpi;
            document.getElementById('resultDate').textContent = userData.date;
            document.getElementById('correctAnswers').textContent = correct;

            let message = '';
            if (score >= 90) {
                message = '🎉 ¡Excelente! Dominas el tema';
            } else if (score >= 70) {
                message = '👍 ¡Muy bien! Buen conocimiento del tema';
            } else if (score >= 60) {
                message = '✅ Aprobado. Continúa estudiando';
            } else {
                message = '📚 Necesitas repasar el material';
            }

            document.getElementById('resultMessage').textContent = message;
        }

        // Descargar PDF
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Recuperar datos del localStorage
            const userData = JSON.parse(localStorage.getItem('examUserData'));
            const results = JSON.parse(localStorage.getItem('examResults'));
            const signature = localStorage.getItem('examSignature');
            const questions = JSON.parse(localStorage.getItem('examQuestions'));
            const answers = JSON.parse(localStorage.getItem('examAnswers'));

            let yPosition = 20;

            // ============ PÁGINA 1: ENCABEZADO Y RESUMEN ============
            
            // Encabezado
            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text('CERTIFICADO DE EVALUACIÓN', 105, 18, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text('Módulo 1: Sistema eLO - Solicitud de Crédito y Asignación Automática', 105, 28, { align: 'center' });
            
            doc.setFontSize(11);
            doc.text('Departamento de Créditos Avanta', 105, 37, { align: 'center' });

            yPosition = 55;

            // Información del evaluado
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Datos del Evaluado:', 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Nombre: ${userData.name}`, 20, yPosition);
            yPosition += 6;
            doc.text(`DPI: ${userData.dpi}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Fecha: ${userData.date}`, 20, yPosition);
            yPosition += 12;

            // Resultados resumidos
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Resumen de Resultados:', 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de Preguntas: ${results.total}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Respuestas Correctas: ${results.correct}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Respuestas Incorrectas: ${results.total - results.correct}`, 20, yPosition);
            yPosition += 12;

            // Puntuación destacada
            doc.setFillColor(248, 249, 250);
            doc.rect(15, yPosition - 5, 180, 25, 'F');
            
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(102, 126, 234);
            doc.text(`PUNTUACIÓN FINAL: ${results.score} / 100 pts`, 105, yPosition + 8, { align: 'center' });

            // Estado
            doc.setFontSize(16);
            if (results.score >= 60) {
                doc.setTextColor(46, 204, 113);
                doc.text('✓ APROBADO', 105, yPosition + 18, { align: 'center' });
            } else {
                doc.setTextColor(231, 76, 60);
                doc.text('✗ NO APROBADO', 105, yPosition + 18, { align: 'center' });
            }

            yPosition += 30;

            // Firma del evaluado
            if (signature) {
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Firma Digital del Evaluado:', 20, yPosition);
                yPosition += 2;
                doc.addImage(signature, 'PNG', 20, yPosition, 70, 23);
                yPosition += 25;
            }

            // ============ PÁGINA 2+: DETALLE DE PREGUNTAS Y RESPUESTAS ============
            
            doc.addPage();
            yPosition = 20;

            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text('DETALLE DE PREGUNTAS Y RESPUESTAS', 105, 10, { align: 'center' });

            yPosition = 25;

            // Iterar sobre todas las preguntas
            for (let i = 0; i < questions.length; i++) {
                const question = questions[i];
                const userAnswer = answers[i];
                const isCorrect = userAnswer === question.answer;

                // Verificar si necesitamos una nueva página
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }

                // Categoría de la pregunta
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text(question.category.toUpperCase(), 20, yPosition);
                yPosition += 6;

                // Número de pregunta y estado
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                
                if (isCorrect) {
                    doc.setTextColor(46, 204, 113);
                    doc.text(`✓`, 15, yPosition);
                } else {
                    doc.setTextColor(231, 76, 60);
                    doc.text(`✗`, 15, yPosition);
                }
                
                doc.setTextColor(0, 0, 0);
                doc.text(`Pregunta ${i + 1}:`, 22, yPosition);
                yPosition += 6;

                // Texto de la pregunta (con wrapping)
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                const questionLines = doc.splitTextToSize(question.q, 170);
                doc.text(questionLines, 20, yPosition);
                yPosition += (questionLines.length * 5);

                // Opciones
                yPosition += 3;
                for (let j = 0; j < question.options.length; j++) {
                    const optionLetter = String.fromCharCode(97 + j); // a, b, c, d
                    const isUserAnswer = userAnswer === optionLetter;
                    const isCorrectAnswer = question.answer === optionLetter;

                    // Verificar espacio
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.setFontSize(8);
                    
                    // Marcar la respuesta del usuario y la correcta
                    if (isUserAnswer && isCorrectAnswer) {
                        // Respuesta correcta del usuario
                        doc.setTextColor(46, 204, 113);
                        doc.setFont(undefined, 'bold');
                        doc.text('➤', 23, yPosition);
                    } else if (isUserAnswer && !isCorrectAnswer) {
                        // Respuesta incorrecta del usuario
                        doc.setTextColor(231, 76, 60);
                        doc.setFont(undefined, 'bold');
                        doc.text('➤', 23, yPosition);
                    } else if (!isUserAnswer && isCorrectAnswer) {
                        // La respuesta correcta (no seleccionada)
                        doc.setTextColor(46, 204, 113);
                        doc.setFont(undefined, 'italic');
                        doc.text('✓', 23, yPosition);
                    }

                    // Texto de la opción
                    if (isUserAnswer) {
                        doc.setFont(undefined, 'bold');
                    } else {
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(0, 0, 0);
                    }

                    const optionLines = doc.splitTextToSize(question.options[j], 160);
                    doc.text(optionLines, 30, yPosition);
                    yPosition += (optionLines.length * 4) + 1;
                }

                // Explicación de la respuesta
                yPosition += 2;
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                if (isCorrect) {
                    doc.setTextColor(46, 204, 113);
                    doc.text(`Respuesta correcta: ${question.answer.toUpperCase()}`, 30, yPosition);
                } else {
                    doc.setTextColor(231, 76, 60);
                    doc.text(`Tu respuesta: ${userAnswer.toUpperCase()} | Correcta: ${question.answer.toUpperCase()}`, 30, yPosition);
                }

                yPosition += 8;

                // Línea separadora
                doc.setDrawColor(200, 200, 200);
                doc.line(20, yPosition, 190, yPosition);
                yPosition += 8;
            }

            // ============ PÁGINA FINAL: FIRMAS DE APROBACIÓN ============
            
            doc.addPage();
            yPosition = 20;

            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text('APROBACIÓN Y VALIDACIÓN', 105, 10, { align: 'center' });

            yPosition = 35;

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text('Este documento certifica que el evaluado ha completado satisfactoriamente la evaluación', 105, yPosition, { align: 'center' });
            yPosition += 5;
            doc.text('del Módulo 1 y requiere la aprobación de las siguientes autoridades:', 105, yPosition, { align: 'center' });
            yPosition += 20;

            // Firma del Coordinador
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('COORDINADOR DE CRÉDITOS', 20, yPosition);
            yPosition += 15;
            
            doc.setLineWidth(0.5);
            doc.setDrawColor(0, 0, 0);
            doc.line(20, yPosition, 90, yPosition);
            yPosition += 5;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('Firma y Sello', 20, yPosition);
            yPosition += 3;
            doc.text(`Fecha: _____/_____/_____`, 20, yPosition);
            yPosition += 25;

            // Firma del Jefe de Créditos
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('JEFE DE CRÉDITOS', 20, yPosition);
            yPosition += 15;
            
            doc.line(20, yPosition, 90, yPosition);
            yPosition += 5;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('Firma y Sello', 20, yPosition);
            yPosition += 3;
            doc.text(`Fecha: _____/_____/_____`, 20, yPosition);
            yPosition += 25;

            // Firma del Gerente de Créditos
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('GERENTE DE CRÉDITOS', 20, yPosition);
            yPosition += 15;
            
            doc.line(20, yPosition, 90, yPosition);
            yPosition += 5;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('Firma y Sello', 20, yPosition);
            yPosition += 3;
            doc.text(`Fecha: _____/_____/_____`, 20, yPosition);

            // Nota al pie
            yPosition = 270;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.setFont(undefined, 'italic');
            doc.text('Este documento es válido únicamente con las tres firmas autorizadas y sus respectivos sellos.', 105, yPosition, { align: 'center' });
            yPosition += 4;
            doc.text('Departamento de Créditos Avanta - Sistema de Evaluación y Capacitación', 105, yPosition, { align: 'center' });

            // Pie de página en todas las páginas
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Página ${i} de ${totalPages}`, 105, 290, { align: 'center' });
            }

            // Descargar
            doc.save(`Evaluacion_${userData.name.replace(/ /g, '_')}_${Date.now()}.pdf`);
        }
    </script>
</body>
</html>
