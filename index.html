<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo 1 - Evaluaci√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: #764ba2;
            text-align: center;
            margin-bottom: 30px;
            font-size: 20px;
            font-weight: normal;
        }

        .qr-section {
            text-align: center;
            margin: 30px 0;
        }

        #qrcode {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .question-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .question-text {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .option {
            display: block;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option input[type="radio"] {
            margin-right: 10px;
        }

        .signature-section {
            margin: 30px 0;
        }

        #signatureCanvas {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
            background: white;
        }

        .signature-buttons {
            text-align: center;
            margin-top: 15px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }

        button:hover {
            background: #5568d3;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        .hidden {
            display: none;
        }

        .result-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

        .score {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .result-message {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 22px;
            }

            h2 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla 1: QR y Bienvenida -->
        <div id="welcomeScreen">
            <h1>M√≥dulo 3</h1>
            <h2>Cambios Importantes en eLO</h2>
            
            <div class="instructions">
                <p><strong>üìã Instrucciones:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>La prueba consta de 10 preguntas aleatorias sobre los cambios importantes en eLO</li>
                    <li>Las preguntas abarcan: validaciones autom√°ticas, listas negras, contactabilidad, an√°lisis, automatizaci√≥n y beneficios</li>
                    <li>Cada pregunta vale 10 puntos</li>
                    <li>Debes completar todos los campos y firmar</li>
                    <li>Al finalizar recibir√°s tu calificaci√≥n y un PDF detallado</li>
                </ul>
            </div>

            <div class="qr-section">
                <p style="margin-bottom: 15px; color: #666;">Escanea el c√≥digo QR para acceder desde tu m√≥vil</p>
                <div id="qrcode"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="startExam()">Iniciar Evaluaci√≥n</button>
            </div>
        </div>

        <!-- Pantalla 2: Datos del Usuario -->
        <div id="userDataScreen" class="hidden">
            <h1>Datos del Evaluado</h1>
            <h2>Por favor ingresa tu informaci√≥n</h2>

            <div class="form-group">
                <label for="userName">Nombre Completo *</label>
                <input type="text" id="userName" placeholder="Ingresa tu nombre completo" required>
            </div>

            <div class="form-group">
                <label for="userDPI">DPI *</label>
                <input type="text" id="userDPI" placeholder="Ingresa tu n√∫mero de DPI" required>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="validateUserData()">Continuar</button>
            </div>
        </div>

        <!-- Pantalla 3: Examen -->
        <div id="examScreen" class="hidden">
            <h1>Evaluaci√≥n - M√≥dulo 1</h1>
            
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>

            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Pregunta <span id="currentQuestion">0</span> de 10
            </p>

            <div id="questionsContainer"></div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="submitAnswers()">Finalizar Evaluaci√≥n</button>
            </div>
        </div>

        <!-- Pantalla 4: Firma -->
        <div id="signatureScreen" class="hidden">
            <h1>Firma Digital</h1>
            <h2>Por favor firma en el recuadro para validar tu evaluaci√≥n</h2>

            <div class="signature-section">
                <canvas id="signatureCanvas" width="600" height="200"></canvas>
                <div class="signature-buttons">
                    <button class="secondary" onclick="clearSignature()">Limpiar Firma</button>
                    <button onclick="submitSignature()">Confirmar y Calificar</button>
                </div>
            </div>
        </div>

        <!-- Pantalla 5: Resultados -->
        <div id="resultScreen" class="hidden">
            <h1>Resultados de la Evaluaci√≥n</h1>
            
            <div class="result-section">
                <p class="result-message">Tu puntuaci√≥n es:</p>
                <div class="score" id="finalScore">0</div>
                <p id="resultMessage" style="font-size: 20px; margin-bottom: 20px;"></p>
                
                <div style="margin-top: 30px;">
                    <p><strong>Nombre:</strong> <span id="resultName"></span></p>
                    <p><strong>DPI:</strong> <span id="resultDPI"></span></p>
                    <p><strong>Fecha:</strong> <span id="resultDate"></span></p>
                    <p><strong>Respuestas Correctas:</strong> <span id="correctAnswers"></span>/10</p>
                </div>

                <button onclick="downloadPDF()" style="margin-top: 30px;">üìÑ Descargar Certificado PDF</button>
                <button class="secondary" onclick="location.reload()" style="margin-top: 10px;">üîÑ Nueva Evaluaci√≥n</button>
            </div>
        </div>
    </div>

    <script>
        // Base de datos de preguntas
        const allQuestions = [
            // Estructura de Mejoras
            {category: "Estructura de Mejoras", q: "¬øCu√°l es una de las √°reas principales de mejora en eLO?", options: ["a) Marketing digital", "b) Precalificaci√≥n", "c) Recursos humanos", "d) Contabilidad"], answer: "b"},
            {category: "Estructura de Mejoras", q: "¬øQu√© incluye la mejora en Solicitud de Cr√©dito?", options: ["a) Eliminaci√≥n de campos", "b) Campos adicionales de contactabilidad y referencias mejoradas", "c) Reducci√≥n de requisitos", "d) Automatizaci√≥n del pago"], answer: "b"},
            {category: "Estructura de Mejoras", q: "¬øQu√© √°rea tiene automatizaci√≥n de procesos y controles de calidad reforzados?", options: ["a) Ventas", "b) Precalificaci√≥n", "c) An√°lisis", "d) Cobranza"], answer: "c"},
            
            // Precalificaci√≥n: Listas Negras
            {category: "Precalificaci√≥n: Listas Negras", q: "¬øCu√°ntos grupos cr√≠ticos de riesgo valida autom√°ticamente el sistema en listas negras?", options: ["a) 1 grupo", "b) 2 grupos", "c) 3 grupos", "d) 4 grupos"], answer: "b"},
            {category: "Precalificaci√≥n: Listas Negras", q: "¬øQu√© tipo de sujetos son validados en las listas negras?", options: ["a) Solo clientes nuevos", "b) Sujetos ingresados por cr√©ditos en an√°lisis y clientes con mala conducta de pago", "c) Empleados de la empresa", "d) Proveedores externos"], answer: "b"},
            {category: "Precalificaci√≥n: Listas Negras", q: "¬øCu√°ndo ocurre la validaci√≥n de listas negras?", options: ["a) Al final del proceso", "b) Despu√©s de la aprobaci√≥n", "c) En tiempo real durante la precalificaci√≥n", "d) Solo cuando lo solicita el analista"], answer: "c"},
            {category: "Precalificaci√≥n: Listas Negras", q: "¬øQu√© busca evitar la validaci√≥n de listas negras?", options: ["a) P√©rdida de datos", "b) Ingreso de solicitudes de alto riesgo", "c) Errores de sistema", "d) Duplicaci√≥n de registros"], answer: "b"},
            
            // Validaciones en Precalificaci√≥n
            {category: "Validaciones en Precalificaci√≥n", q: "¬øQu√© identifican las validaciones de clientes recurrentes?", options: ["a) Solo clientes nuevos", "b) Sujetos con cr√©ditos activos y clientes con cancelaciones previas", "c) Clientes VIP", "d) Empleados"], answer: "b"},
            {category: "Validaciones en Precalificaci√≥n", q: "¬øQu√© son los K.O. Autom√°ticos?", options: ["a) Aprobaciones r√°pidas", "b) Validaci√≥n instant√°nea de variables no aprobadas por pol√≠tica crediticia", "c) Eliminaci√≥n de solicitudes", "d) Reportes autom√°ticos"], answer: "b"},
            {category: "Validaciones en Precalificaci√≥n", q: "¬øPara qu√© pa√≠s est√° disponible la conexi√≥n con RENAP?", options: ["a) El Salvador", "b) Honduras", "c) Guatemala", "d) Nicaragua"], answer: "c"},
            {category: "Validaciones en Precalificaci√≥n", q: "¬øQu√© elimina la conexi√≥n con RENAP?", options: ["a) Requisitos de documentaci√≥n", "b) Errores de digitaci√≥n al verificar datos de identidad", "c) Tiempos de espera", "d) Costos operativos"], answer: "b"},
            {category: "Validaciones en Precalificaci√≥n", q: "¬øC√≥mo es la integraci√≥n con RENAP?", options: ["a) Manual", "b) V√≠a correo electr√≥nico", "c) Por API", "d) Por tel√©fono"], answer: "c"},
            
            // Solicitud: Contactabilidad Mejorada
            {category: "Solicitud: Contactabilidad Mejorada", q: "¬øCu√°ntos campos de contacto adicionales est√°n disponibles?", options: ["a) 2 campos", "b) 3 campos", "c) 4 campos", "d) 5 campos"], answer: "c"},
            {category: "Solicitud: Contactabilidad Mejorada", q: "¬øQu√© se valida en los campos de tel√©fonos adicionales?", options: ["a) Que sean n√∫meros internacionales", "b) Que sean del mismo operador", "c) El n√∫mero propio del cliente", "d) Que sean n√∫meros fijos"], answer: "c"},
            {category: "Solicitud: Contactabilidad Mejorada", q: "¬øQu√© nuevo campo permite registrar preferencias del cliente?", options: ["a) M√©todo de pago preferido", "b) Horario de contactabilidad", "c) Sucursal favorita", "d) Tipo de producto"], answer: "b"},
            {category: "Solicitud: Contactabilidad Mejorada", q: "¬øPara qu√© sirve el campo de comentarios en la solicitud?", options: ["a) Calificar al vendedor", "b) Registrar quejas", "c) Capturar cualquier requerimiento especial del cliente", "d) Evaluar el servicio"], answer: "c"},
            
            // Nuevos Campos Cr√≠ticos
            {category: "Nuevos Campos Cr√≠ticos", q: "¬øQu√© informaci√≥n del recibo de servicios se incluye ahora?", options: ["a) Monto a pagar", "b) Tipo y n√∫mero de contador", "c) Fecha de vencimiento", "d) Nombre del proveedor"], answer: "b"},
            {category: "Nuevos Campos Cr√≠ticos", q: "¬øEn qu√© validaci√≥n se utiliza el n√∫mero de contador?", options: ["a) Solo verificaci√≥n de domicilio", "b) Lista negra, coincidencias con solicitudes anteriores y verificaci√≥n de domicilio", "c) √önicamente en an√°lisis de cr√©dito", "d) Solo para reportes"], answer: "b"},
            {category: "Nuevos Campos Cr√≠ticos", q: "¬øCu√°ntas referencias personales son requeridas?", options: ["a) 1 referencia", "b) 2 referencias", "c) 3 referencias", "d) 4 referencias"], answer: "b"},
            {category: "Nuevos Campos Cr√≠ticos", q: "¬øCu√°ntas referencias familiares son obligatorias?", options: ["a) 1 referencia", "b) 2 referencias", "c) 3 referencias", "d) No son obligatorias"], answer: "b"},
            {category: "Nuevos Campos Cr√≠ticos", q: "¬øQu√© es obligatorio especificar en las referencias?", options: ["a) Nivel educativo", "b) Ingresos mensuales", "c) Parentesco real", "d) Ocupaci√≥n"], answer: "c"},
            
            // An√°lisis: Seguimiento y Control
            {category: "An√°lisis: Seguimiento y Control", q: "¬øQu√© permite revisar el bot√≥n de Hist√≥rico de Solicitud?", options: ["a) Solo la fecha de ingreso", "b) Tracking completo y tiempos de gesti√≥n", "c) √önicamente documentos adjuntos", "d) Solo el nombre del analista"], answer: "b"},
            {category: "An√°lisis: Seguimiento y Control", q: "¬øPara qu√© sirven los Botones de Estado?", options: ["a) Para eliminar solicitudes", "b) Para coordinar verificaciones y establecer estados/subestados", "c) Para aprobar autom√°ticamente", "d) Para generar reportes"], answer: "b"},
            {category: "An√°lisis: Seguimiento y Control", q: "¬øQu√© controla la funci√≥n de Confirmaci√≥n Pendiente?", options: ["a) Pagos atrasados", "b) Documentos faltantes", "c) Procesos ajenos al an√°lisis principal del cr√©dito", "d) Errores del sistema"], answer: "c"},
            
            // Automatizaci√≥n Inteligente
            {category: "Automatizaci√≥n Inteligente", q: "¬øC√≥mo distribuye solicitudes la Asignaci√≥n Autom√°tica?", options: ["a) Aleatoriamente", "b) Por orden de llegada", "c) De forma inteligente para optimizar la operaci√≥n", "d) Manualmente"], answer: "c"},
            {category: "Automatizaci√≥n Inteligente", q: "¬øQu√© previene la Validaci√≥n de Llamadas?", options: ["a) Llamadas no autorizadas", "b) Subir la misma confirmaci√≥n telef√≥nica en campos distintos", "c) N√∫meros duplicados", "d) Horarios incorrectos"], answer: "b"},
            {category: "Automatizaci√≥n Inteligente", q: "¬øQu√© confirma la revisi√≥n de Procesos Completados?", options: ["a) Que el cliente pag√≥", "b) Que todos los documentos est√°n firmados", "c) Que la solicitud ha sido trabajada en su totalidad", "d) Que no hay errores"], answer: "c"},
            
            // Controles Adicionales en An√°lisis
            {category: "Controles Adicionales", q: "¬øCu√°ndo se captura el Segundo Tel√©fono Confirmado?", options: ["a) Al inicio de la solicitud", "b) Cuando el solicitante indica otro n√∫mero durante la llamada de confirmaci√≥n", "c) Solo si el primer n√∫mero falla", "d) Al finalizar el proceso"], answer: "b"},
            {category: "Controles Adicionales", q: "¬øEn qu√© campos cr√≠ticos busca coincidencias el sistema?", options: ["a) Solo en el nombre", "b) Solo en la direcci√≥n", "c) En tel√©fono, identificaci√≥n, NIT o n√∫mero de contador", "d) Solo en referencias"], answer: "c"},
            
            // Beneficios Clave
            {category: "Beneficios Clave", q: "¬øQu√© beneficio proporciona la automatizaci√≥n de tareas repetitivas?", options: ["a) Reducci√≥n de personal", "b) Mayor eficiencia", "c) Menor calidad", "d) M√°s errores"], answer: "b"},
            {category: "Beneficios Clave", q: "¬øCu√°l es el objetivo principal de las nuevas funcionalidades en eLO?", options: ["a) Aumentar costos operativos", "b) Complicar los procesos", "c) Mejorar eficiencia, precisi√≥n, reducir riesgo y tener trazabilidad total", "d) Eliminar controles"], answer: "c"}
        ];

        // Variables globales
        let selectedQuestions = [];
        let userAnswers = [];
        let userData = {};
        let signatureData = null;
        let canvas, ctx;
        let isDrawing = false;

        // Generar QR Code al cargar la p√°gina
        window.onload = function() {
            const currentURL = window.location.href;
            new QRCode(document.getElementById("qrcode"), {
                text: currentURL,
                width: 200,
                height: 200,
                colorDark: "#667eea",
                colorLight: "#ffffff",
            });
        };

        // Funci√≥n para iniciar el examen
        function startExam() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('userDataScreen').classList.remove('hidden');
        }

        // Validar datos del usuario
        function validateUserData() {
            const name = document.getElementById('userName').value.trim();
            const dpi = document.getElementById('userDPI').value.trim();

            if (name === '' || dpi === '') {
                alert('Por favor completa todos los campos');
                return;
            }

            userData = {
                name: name,
                dpi: dpi,
                date: new Date().toLocaleString('es-GT')
            };

            // Guardar en localStorage
            localStorage.setItem('examUserData', JSON.stringify(userData));

            // Generar preguntas aleatorias
            generateRandomQuestions();

            // Mostrar pantalla de examen
            document.getElementById('userDataScreen').classList.add('hidden');
            document.getElementById('examScreen').classList.remove('hidden');
        }

        // Generar 10 preguntas aleatorias
        function generateRandomQuestions() {
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            selectedQuestions = shuffled.slice(0, 10);
            
            // Guardar en localStorage
            localStorage.setItem('examQuestions', JSON.stringify(selectedQuestions));

            renderQuestions();
        }

        // Renderizar preguntas
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            selectedQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.innerHTML = `
                    <div style="font-size: 11px; color: #667eea; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">
                        ${question.category}
                    </div>
                    <div class="question-text">${index + 1}. ${question.q}</div>
                    ${question.options.map((option, optIndex) => `
                        <label class="option">
                            <input type="radio" name="question${index}" value="${String.fromCharCode(97 + optIndex)}" onchange="updateProgress()">
                            ${option}
                        </label>
                    `).join('')}
                `;
                container.appendChild(questionCard);
            });
        }

        // Actualizar progreso
        function updateProgress() {
            let answered = 0;
            for (let i = 0; i < 10; i++) {
                const selected = document.querySelector(`input[name="question${i}"]:checked`);
                if (selected) answered++;
            }

            const progress = (answered / 10) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = answered;
        }

        // Enviar respuestas
        function submitAnswers() {
            userAnswers = [];
            let allAnswered = true;

            for (let i = 0; i < 10; i++) {
                const selected = document.querySelector(`input[name="question${i}"]:checked`);
                if (!selected) {
                    allAnswered = false;
                    break;
                }
                userAnswers.push(selected.value);
            }

            if (!allAnswered) {
                alert('Por favor responde todas las preguntas antes de continuar');
                return;
            }

            // Guardar respuestas
            localStorage.setItem('examAnswers', JSON.stringify(userAnswers));

            // Mostrar pantalla de firma
            document.getElementById('examScreen').classList.add('hidden');
            document.getElementById('signatureScreen').classList.remove('hidden');

            // Inicializar canvas de firma
            initSignatureCanvas();
        }

        // Inicializar canvas de firma
        function initSignatureCanvas() {
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');

            // Ajustar para pantallas m√≥viles
            if (window.innerWidth < 600) {
                canvas.width = window.innerWidth - 80;
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events para m√≥viles
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function submitSignature() {
            // Verificar que hay firma
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let hasSignature = false;

            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 0) {
                    hasSignature = true;
                    break;
                }
            }

            if (!hasSignature) {
                alert('Por favor firma antes de continuar');
                return;
            }

            signatureData = canvas.toDataURL();
            localStorage.setItem('examSignature', signatureData);

            // Calcular resultados
            calculateResults();
        }

        // Calcular resultados
        function calculateResults() {
            let correct = 0;
            
            for (let i = 0; i < 10; i++) {
                if (userAnswers[i] === selectedQuestions[i].answer) {
                    correct++;
                }
            }

            const score = correct * 10;
            
            // Guardar resultados
            const results = {
                score: score,
                correct: correct,
                total: 10,
                date: userData.date
            };
            localStorage.setItem('examResults', JSON.stringify(results));

            // Mostrar resultados
            showResults(score, correct);
        }

        // Mostrar resultados
        function showResults(score, correct) {
            document.getElementById('signatureScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');

            document.getElementById('finalScore').textContent = score + ' pts';
            document.getElementById('resultName').textContent = userData.name;
            document.getElementById('resultDPI').textContent = userData.dpi;
            document.getElementById('resultDate').textContent = userData.date;
            document.getElementById('correctAnswers').textContent = correct;

            let message = '';
            if (score >= 90) {
                message = 'üéâ ¬°Excelente! Dominas el tema';
            } else if (score >= 70) {
                message = 'üëç ¬°Muy bien! Buen conocimiento del tema';
            } else if (score >= 60) {
                message = '‚úÖ Aprobado. Contin√∫a estudiando';
            } else {
                message = 'üìö Necesitas repasar el material';
            }

            document.getElementById('resultMessage').textContent = message;
        }

        // Descargar PDF
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Recuperar datos del localStorage
            const userData = JSON.parse(localStorage.getItem('examUserData'));
            const results = JSON.parse(localStorage.getItem('examResults'));
            const signature = localStorage.getItem('examSignature');
            const questions = JSON.parse(localStorage.getItem('examQuestions'));
            const answers = JSON.parse(localStorage.getItem('examAnswers'));

            let yPosition = 20;

            // ============ P√ÅGINA 1: ENCABEZADO Y RESUMEN ============
            
            // Encabezado
            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text('CERTIFICADO DE EVALUACI√ìN', 105, 18, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text('M√≥dulo 3: Cambios Importantes en eLO', 105, 28, { align: 'center' });
            
            doc.setFontSize(11);
            doc.text('Departamento de Cr√©ditos Avanta', 105, 37, { align: 'center' });

            yPosition = 55;

            // Informaci√≥n del evaluado
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Datos del Evaluado:', 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Nombre: ${userData.name}`, 20, yPosition);
            yPosition += 6;
            doc.text(`DPI: ${userData.dpi}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Fecha: ${userData.date}`, 20, yPosition);
            yPosition += 12;

            // Resultados resumidos
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Resumen de Resultados:', 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de Preguntas: ${results.total}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Respuestas Correctas: ${results.correct}`, 20, yPosition);
            yPosition += 6;
            doc.text(`Respuestas Incorrectas: ${results.total - results.correct}`, 20, yPosition);
            yPosition += 12;

            // Puntuaci√≥n destacada
            doc.setFillColor(248, 249, 250);
            doc.rect(15, yPosition - 5, 180, 25, 'F');
            
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(102, 126, 234);
            doc.text(`PUNTUACI√ìN FINAL: ${results.score} / 100 pts`, 105, yPosition + 8, { align: 'center' });

            // Estado
            doc.setFontSize(16);
            if (results.score >= 60) {
                doc.setTextColor(46, 204, 113);
                doc.text('‚úì APROBADO', 105, yPosition + 18, { align: 'center' });
            } else {
                doc.setTextColor(231, 76, 60);
                doc.text('‚úó NO APROBADO', 105, yPosition + 18, { align: 'center' });
            }

            yPosition += 30;

            // Firma del evaluado
            if (signature) {
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Firma Digital del Evaluado:', 20, yPosition);
                yPosition += 2;
                doc.addImage(signature, 'PNG', 20, yPosition, 70, 23);
                yPosition += 25;
            }

            // ============ P√ÅGINA 2+: DETALLE DE PREGUNTAS Y RESPUESTAS ============
            
            doc.addPage();
            yPosition = 20;

            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text('DETALLE DE PREGUNTAS Y RESPUESTAS', 105, 10, { align: 'center' });

            yPosition = 25;

            // Iterar sobre todas las preguntas
            for (let i = 0; i < questions.length; i++) {
                const question = questions[i];
                const userAnswer = answers[i];
                const isCorrect = userAnswer === question.answer;

                // Verificar si necesitamos una nueva p√°gina
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }

                // Categor√≠a de la pregunta
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text(question.category.toUpperCase(), 20, yPosition);
                yPosition += 6;

                // N√∫mero de pregunta y estado
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                
                if (isCorrect) {
                    doc.setTextColor(46, 204, 113);
                    doc.text(`‚úì`, 15, yPosition);
                } else {
                    doc.setTextColor(231, 76, 60);
                    doc.text(`‚úó`, 15, yPosition);
                }
                
                doc.setTextColor(0, 0, 0);
                doc.text(`Pregunta ${i + 1}:`, 22, yPosition);
                yPosition += 6;

                // Texto de la pregunta (con wrapping)
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                const questionLines = doc.splitTextToSize(question.q, 170);
                doc.text(questionLines, 20, yPosition);
                yPosition += (questionLines.length * 5);

                // Opciones
                yPosition += 3;
                for (let j = 0; j < question.options.length; j++) {
                    const optionLetter = String.fromCharCode(97 + j); // a, b, c, d
                    const isUserAnswer = userAnswer === optionLetter;
                    const isCorrectAnswer = question.answer === optionLetter;

                    // Verificar espacio
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.setFontSize(8);
                    
                    // Marcar la respuesta del usuario y la correcta
                    if (isUserAnswer && isCorrectAnswer) {
                        // Respuesta correcta del usuario
                        doc.setTextColor(46, 204, 113);
                        doc.setFont(undefined, 'bold');
                        doc.text('‚û§', 23, yPosition);
                    } else if (isUserAnswer && !isCorrectAnswer) {
                        // Respuesta incorrecta del usuario
                        doc.setTextColor(231, 76, 60);
                        doc.setFont(undefined, 'bold');
                        doc.text('‚û§', 23, yPosition);
                    } else if (!isUserAnswer && isCorrectAnswer) {
                        // La respuesta correcta (no seleccionada)
                        doc.setTextColor(46, 204, 113);
                        doc.setFont(undefined, 'italic');
                        doc.text('‚úì', 23, yPosition);
                    }

                    // Texto de la opci√≥n
                    if (isUserAnswer) {
                        doc.setFont(undefined, 'bold');
                    } else {
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(0, 0, 0);
                    }

                    const optionLines = doc.splitTextToSize(question.options[j], 160);
                    doc.text(optionLines, 30, yPosition);
                    yPosition += (optionLines.length * 4) + 1;
                }

                // Explicaci√≥n de la respuesta
                yPosition += 2;
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                if (isCorrect) {
                    doc.setTextColor(46, 204, 113);
                    doc.text(`Respuesta correcta: ${question.answer.toUpperCase()}`, 30, yPosition);
                } else {
                    doc.setTextColor(231, 76, 60);
                    doc.text(`Tu respuesta: ${userAnswer.toUpperCase()} | Correcta: ${question.answer.toUpperCase()}`, 30, yPosition);
                }

                yPosition += 8;

                // L√≠nea separadora
                doc.setDrawColor(200, 200, 200);
                doc.line(20, yPosition, 190, yPosition);
                yPosition += 8;
            }

            // ============ P√ÅGINA FINAL: FIRMAS DE APROBACI√ìN ============
            
            doc.addPage();
            yPosition = 20;

            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text('APROBACI√ìN Y VALIDACI√ìN', 105, 10, { align: 'center' });

            yPosition = 35;

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text('Este documento certifica que el evaluado ha completado satisfactoriamente la evaluaci√≥n', 105, yPosition, { align: 'center' });
            yPosition += 5;
            doc.text('del M√≥dulo 1 y requiere la aprobaci√≥n de las siguientes autoridades:', 105, yPosition, { align: 'center' });
            yPosition += 20;

            // Firma del Coordinador
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('COORDINADOR DE CR√âDITOS', 20, yPosition);
            yPosition += 15;
            
            doc.setLineWidth(0.5);
            doc.setDrawColor(0, 0, 0);
            doc.line(20, yPosition, 90, yPosition);
            yPosition += 5;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('Firma y Sello', 20, yPosition);
            yPosition += 3;
            doc.text(`Fecha: _____/_____/_____`, 20, yPosition);
            yPosition += 25;

            // Firma del Jefe de Cr√©ditos
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('JEFE DE CR√âDITOS', 20, yPosition);
            yPosition += 15;
            
            doc.line(20, yPosition, 90, yPosition);
            yPosition += 5;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('Firma y Sello', 20, yPosition);
            yPosition += 3;
            doc.text(`Fecha: _____/_____/_____`, 20, yPosition);
            yPosition += 25;

            // Firma del Gerente de Cr√©ditos
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('GERENTE DE CR√âDITOS', 20, yPosition);
            yPosition += 15;
            
            doc.line(20, yPosition, 90, yPosition);
            yPosition += 5;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('Firma y Sello', 20, yPosition);
            yPosition += 3;
            doc.text(`Fecha: _____/_____/_____`, 20, yPosition);

            // Nota al pie
            yPosition = 270;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.setFont(undefined, 'italic');
            doc.text('Este documento es v√°lido √∫nicamente con las tres firmas autorizadas y sus respectivos sellos.', 105, yPosition, { align: 'center' });
            yPosition += 4;
            doc.text('Departamento de Cr√©ditos Avanta - Sistema de Evaluaci√≥n y Capacitaci√≥n', 105, yPosition, { align: 'center' });

            // Pie de p√°gina en todas las p√°ginas
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`P√°gina ${i} de ${totalPages}`, 105, 290, { align: 'center' });
            }

            // Descargar
            doc.save(`Evaluacion_${userData.name.replace(/ /g, '_')}_${Date.now()}.pdf`);
        }
    </script>
</body>
</html>
